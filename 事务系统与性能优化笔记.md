> æœ¬æ–‡æ·±å…¥æ¢è®¨ Tiny-LSM çš„äº‹åŠ¡ç®¡ç†ã€æ•…éšœæ¢å¤å’Œæ€§èƒ½ä¼˜åŒ–æœºåˆ¶ï¼Œæ¶µç›– MVCCã€WALã€Bloom Filterã€BlockCache å’Œ Compaction ç­‰å…³é”®å­ç³»ç»Ÿã€‚

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šäº‹åŠ¡å­ç³»ç»Ÿ (Transaction & MVCC)

### 1.1 äº‹åŠ¡æ¶æ„æ¦‚è§ˆ

Tiny-LSM é‡‡ç”¨**ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆOCCï¼‰+ MVCC**æ¶æ„ï¼Œæ”¯æŒå¤šç§éš”ç¦»çº§åˆ«ã€‚äº‹åŠ¡ç³»ç»Ÿç”±ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼š

```mermaid
graph TB
    subgraph TransSystem ["äº‹åŠ¡å­ç³»ç»Ÿ"]
        User["ç”¨æˆ·ä»£ç "]
        LSM["LSM åŒ…è£…ç±»"]
        TranManager["TranManager<br/>ï¼ˆäº‹åŠ¡å…¨å±€åè°ƒï¼‰"]
        TranContext["TranContext<br/>ï¼ˆå•ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡ï¼‰"]
        WAL["WAL æ—¥å¿—"]
        Engine["LSMEngine<br/>ï¼ˆå­˜å‚¨å¼•æ“ï¼‰"]
    end

    User -->|begin_tran| LSM
    LSM -->|new_tranc| TranManager
    TranManager -->|åˆ›å»º| TranContext
    TranContext -->|å†™å…¥ç¼“å­˜| temp_map["temp_map_<br/>ï¼ˆå†™æ“ä½œç¼“å­˜ï¼‰"]
    TranContext -->|commit| TranManager
    TranManager -->|åºåˆ—åŒ–| WAL
    TranManager -->|åº”ç”¨æ›´æ–°| Engine
    
    style TranManager fill:#fff9c4
    style TranContext fill:#e1f5fe
    style WAL fill:#fff3e0
    style Engine fill:#e8f5e9
    style temp_map fill:#f3e5f5
```

### 1.2 TranManager ä¸äº‹åŠ¡ ID åˆ†é…

```cpp
class TranManager {
private:
  std::atomic<uint64_t> nextTransactionId_ = 1;      // å…¨å±€é€’å¢
  std::atomic<uint64_t> max_flushed_tranc_id_ = 0;   // å·²åˆ·ç›˜çš„æœ€å¤§ ID
  std::atomic<uint64_t> max_finished_tranc_id_ = 0;  // å·²å®Œæˆçš„æœ€å¤§ ID
  std::map<uint64_t, std::shared_ptr<TranContext>> activeTrans_;  // æ´»è·ƒäº‹åŠ¡è¡¨
};
```

**å…³é”®è®¾è®¡**ï¼š

- **å•è°ƒé€’å¢ tranc_id**ï¼šæ¯ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å•è°ƒé€’å¢ IDï¼Œç”¨ä½œç‰ˆæœ¬æˆ³
- **åŸå­æ“ä½œ**ï¼šä½¿ç”¨ `std::atomic<uint64_t>` ä¿è¯æ— é”çš„ ID åˆ†é…
- **ä¸¤å±‚æ°´ä½çº¿**ï¼š

  - `max_flushed_tranc_id_`ï¼šå·²æŒä¹…åŒ–åˆ° SST çš„æœ€å¤§äº‹åŠ¡ IDï¼ˆå†²çªæ£€æµ‹ç”¨ï¼‰
  - `max_finished_tranc_id_`ï¼šå·²æäº¤æˆ–å›æ»šçš„æœ€å¤§äº‹åŠ¡ IDï¼ˆWAL æ¸…ç†ç”¨ï¼‰

### 1.3 TranContext çš„ç”Ÿå‘½å‘¨æœŸä¸ç¼“å†²è®¾è®¡

```cpp
class TranContext {
public:
  std::unordered_map<std::string, std::string> temp_map_;  // å†™æ“ä½œç¼“å­˜
  std::vector<Record> operations;                           // WAL æ—¥å¿—åºåˆ—
  enum IsolationLevel isolation_level_;
  
private:
  std::unordered_map<std::string, std::optional<...>> read_map_;      // è¯»é›†åˆï¼ˆMVCCï¼‰
  std::unordered_map<std::string, std::optional<...>> rollback_map_;  // å›æ»šæ•°æ®
};
```

#### ä¸‰ç§éš”ç¦»çº§åˆ«çš„ç­–ç•¥å·®å¼‚

| éš”ç¦»çº§åˆ« | Put è¡Œä¸º                | Get è¡Œä¸º                 | Commit å†²çªæ£€æµ‹           |
| ---------- | ------------------------- | -------------------------- | --------------------------- |
| **READ_UNCOMMITTED**         | ç›´æ¥å†™ MemTableï¼ˆè„å†™ï¼‰ | è¯»æœ€æ–°ç‰ˆæœ¬               | æ—                         |
| **READ_COMMITTED**         | ç¼“å­˜åˆ° temp_map_        | æ¯æ¬¡ä» MemTable è¯»å–     | å†™å†²çªæ£€æµ‹                |
| **REPEATABLE_READ**         | ç¼“å­˜åˆ° temp_map_        | ç¼“å­˜åˆ° read_map_ï¼ˆå¿«ç…§ï¼‰ | å†™å†²çª + è¯»å†²çªæ£€æµ‹       |
| **SERIALIZABLE**         | ç¼“å­˜åˆ° temp_map_        | ç¼“å­˜åˆ° read_map_ï¼ˆå¿«ç…§ï¼‰ | ä¸¥æ ¼å†²çªæ£€æµ‹ + å¹½çµè¯»é˜²æŠ¤ |

### 1.4 äº‹åŠ¡å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

```mermaid
sequenceDiagram
    box "ç”¨æˆ·ä¾§"
        participant User as ç”¨æˆ·ä»£ç 
    end
    box "äº‹åŠ¡åè°ƒ"
        participant LSM as LSM
        participant TranMgr as TranManager
    end
    box "å•ä¸ªäº‹åŠ¡"
        participant TranCtx as TranContext
    end
    box "å­˜å‚¨å¼•æ“"
        participant MemTbl as MemTable
        participant WAL as WAL
        participant Engine as LSMEngine
    end

    User->>LSM: begin_tran(REPEATABLE_READ)
    LSM->>TranMgr: new_tranc(REPEATABLE_READ)
    TranMgr->>TranMgr: tranc_id = nextTransactionId_++<br/>åˆ†é…å•è°ƒé€’å¢ ID
    TranMgr->>TranCtx: åˆ›å»ºæ–° TranContext<br/>(tranc_id, isolation_level)
    TranMgr-->>LSM: è¿”å› TranContext æŒ‡é’ˆ

    User->>TranCtx: put("key1", "value1")
    Note over TranCtx: éš”ç¦»çº§åˆ« = REPEATABLE_READ<br/>ç¼“å­˜åˆ° temp_map_<br/>ä¸å†™ MemTable
    TranCtx->>TranCtx: temp_map_["key1"] = "value1"<br/>operations.push(putRecord(...))

    User->>TranCtx: get("key1")
    Note over TranCtx: å…ˆæŸ¥ temp_map_ï¼Œå†æŸ¥ MemTable
    TranCtx->>TranCtx: è¿”å› "value1"ï¼ˆè¯»é›†åˆç¼“å­˜ï¼‰

    User->>TranCtx: remove("key2")
    TranCtx->>TranCtx: temp_map_["key2"] = ""<br/>operations.push(deleteRecord(...))

    User->>TranCtx: commit()
    activate TranCtx
    
    Note over TranCtx: â–¶ï¸ é˜¶æ®µ 1ï¼šå†²çªæ£€æµ‹<br/>æ£€æŸ¥ temp_map_ ä¸­çš„ key<br/>æ˜¯å¦ä¸ SST ä¸­ç‰ˆæœ¬å†²çª
    TranCtx->>Engine: sst_get_(key, 0)<br/>æŸ¥è¯¢ SSTï¼ˆå¿½ç•¥äº‹åŠ¡å¯è§æ€§ï¼‰
    alt å‘ç°å†™å†²çªï¼ˆSST ä¸­ç‰ˆæœ¬æ›´æ–°ï¼‰
        TranCtx->>TranCtx: isAborted = true<br/>è¿”å› false
        TranCtx-->>User: âŒ äº‹åŠ¡ä¸­æ­¢
    else æ— å†²çª
        Note over TranCtx: âœ… é€šè¿‡å†²çªæ£€æµ‹
    end
    
    Note over TranCtx: â–¶ï¸ é˜¶æ®µ 2ï¼šWAL æŒä¹…åŒ–<br/>åºåˆ—åŒ–æ‰€æœ‰æ“ä½œåˆ° WAL
    TranCtx->>TranCtx: operations.push(commitRecord(tranc_id))
    TranCtx->>WAL: write_to_wal(operations)<br/>å†™å…¥ BEGIN + æ‰€æœ‰æ“ä½œ + COMMIT
    Note over WAL: Record ç¼–ç ï¼š<br/>record_len | tranc_id | op_type | key_len | key | val_len | val

    Note over TranCtx: â–¶ï¸ é˜¶æ®µ 3ï¼šåº”ç”¨æ›´æ–°<br/>ï¼ˆä»…å½“ test_fail = falseï¼‰
    TranCtx->>MemTbl: put_(key, value, tranc_id)<br/>æ— é”ç‰ˆæœ¬ï¼Œç›´æ¥æ›´æ–°
    Note over MemTbl: SkipList è®°å½•ç‰ˆæœ¬é“¾<br/>(key, value, tranc_id)
    
    TranCtx->>TranMgr: æ›´æ–° max_finished_tranc_id_
    TranCtx->>TranCtx: isCommited = true
    TranCtx-->>User: âœ… äº‹åŠ¡å·²æäº¤

    deactivate TranCtx
    
    Note over LSM: åç»­è¯»å–æ—¶<br/>æ ¹æ® tranc_id å¯è§æ€§<br/>åˆ¤æ–­æ˜¯å¦è¿”å›æ­¤ç‰ˆæœ¬
```

### 1.5 Record ç¼–ç æ ¼å¼ä¸ WAL æŒä¹…åŒ–

#### Record çš„å†…å­˜å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CREATE / COMMIT / ROLLBACK          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ record_len (2B) â”‚ tranc_id (8B) â”‚ op_type (1B/4B)  â”‚
â”‚ æ€»é•¿åº¦          â”‚ äº‹åŠ¡ ID       â”‚ æ“ä½œç±»å‹         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PUT / DELETE æ“ä½œ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ record_len â”‚ tranc_id â”‚ op_type â”‚ key_len â”‚ key â”‚ value_len â”‚ value â”‚
â”‚ (2B)       â”‚ (8B)     â”‚ (1/4B)  â”‚ (2B)    â”‚ ... â”‚ (2B)      â”‚ ...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¼–ç æµç¨‹**ï¼ˆsrc/wal/record.cppï¼‰ï¼š

1. è®¡ç®—æ€»é•¿åº¦ record_len = 2 + 8 + 1 + 2 + key_size + 2 + value_size
2. memcpy æŒ‰é¡ºåºå†™å…¥å„å­—æ®µ
3. è¿”å›äºŒè¿›åˆ¶ vector<uint8_t>

**è§£ç æµç¨‹**ï¼š

1. è¯»å– record_lenï¼Œç¡®å®šè®°å½•è¾¹ç•Œ
2. ä¾æ¬¡ memcpy æå– tranc_idã€op_typeã€keyã€value
3. æ”¯æŒæµå¼è§£ç ï¼ˆpos æŒ‡é’ˆé€æ­¥æ¨è¿›ï¼‰

#### WAL ç¼“å†²ä¸åˆ·æ–°

```cpp
class WAL {
private:
  std::vector<Record> log_buffer_;  // å†…å­˜ç¼“å†²
  size_t buffer_size_;              // ç¼“å†²å®¹é‡ï¼ˆå¦‚ 64KBï¼‰
  
public:
  void log(const std::vector<Record> &records, bool force_flush = false);
  void flush();  // å°†ç¼“å†²å†™å…¥ç£ç›˜
};
```

**ç­–ç•¥**ï¼š

- **æ‰¹é‡ç¼“å†²**ï¼šå¤šä¸ªäº‹åŠ¡çš„ Record ç´¯ç§¯åˆ°ç¼“å†²åŒº
- **å¼‚æ­¥åˆ·æ–°**ï¼šåå°çº¿ç¨‹å®šæœŸ flushï¼Œæˆ–è¾¾åˆ°å¤§å°é˜ˆå€¼
- **å¼ºåˆ¶åˆ·æ–°**ï¼šcommit æ—¶è®¾ç½® force_flush = trueï¼Œç¡®ä¿æŒä¹…åŒ–

### 1.6 MVCC å¯è§æ€§è§„åˆ™

```mermaid
graph TB
    Start["Get(key, tranc_id)"]
    
    subgraph VersionChain ["SkipList ä¸­çš„ç‰ˆæœ¬é“¾"]
        V1["(key, v1, tranc_id=100)"]
        V2["(key, v2, tranc_id=150)"]
        V3["(key, v3, tranc_id=200)"]
        V1 -->|æ›´æ–°é“¾| V2
        V2 -->|æ›´æ–°é“¾| V3
    end
    
    subgraph Filter ["ç‰ˆæœ¬å¯è§æ€§è¿‡æ»¤"]
        Rule1["è§„åˆ™ 1ï¼štranc_id â‰¤ å½“å‰äº‹åŠ¡ ID"]
        Rule2["è§„åˆ™ 2ï¼šé Tombstoneï¼ˆå€¼ä¸ä¸ºç©ºï¼‰"]
        Rule3["è§„åˆ™ 3ï¼šæœ€æ–°ç‰ˆæœ¬ä¼˜å…ˆ"]
    end
    
    subgraph Result ["å¯è§æ€§ç»“æœ"]
        Vis_100["âœ… tranc_id=100 å¯¹äº‹åŠ¡ 200+ å¯è§"]
        Vis_150["âœ… tranc_id=150 å¯¹äº‹åŠ¡ 150+ å¯è§"]
        Invis_200["âŒ tranc_id=200 å¯¹äº‹åŠ¡ <200 ä¸å¯è§"]
        Tomb["âŒ å€¼ä¸ºç©º = Tombstoneï¼ˆå·²åˆ é™¤ï¼‰"]
    end
    
    Start --> VersionChain
    VersionChain --> Filter
    Filter --> Rule1
    Filter --> Rule2
    Filter --> Rule3
    Rule1 --> Result
    Rule2 --> Result
    Rule3 --> Result

    style Start fill:#fff9c4
    style VersionChain fill:#e0f2f1
    style Filter fill:#fff3e0
    style Result fill:#c8e6c9
```

**æ ¸å¿ƒä¼ªä»£ç **ï¼ˆåœ¨ BlockIterator/SstIterator ä¸­å®ç°ï¼‰ï¼š

```cpp
std::optional<std::string> BlockIterator::skip_by_tranc_id() {
  while (is_valid()) {
    // è·å–å½“å‰ entry çš„ç‰ˆæœ¬æˆ³
    uint64_t entry_tranc_id = get_tranc_id_at(current_index);
    
    if (entry_tranc_id <= query_tranc_id) {
      // âœ… ç‰ˆæœ¬å¯¹å½“å‰äº‹åŠ¡å¯è§
      std::string value = get_value_at(current_index);
      if (value.size() > 0) {
        // é Tombstoneï¼Œè¿”å›
        return value;
      } else {
        // Tombstoneï¼Œè¯´æ˜ key å·²è¢«åˆ é™¤ï¼Œç»§ç»­æŸ¥å‰ä¸€ç‰ˆæœ¬
        ++current_index;  // æˆ–ä»å…¶ä»–å±‚æŸ¥è¯¢
        return std::nullopt;
      }
    } else {
      // âŒ ç‰ˆæœ¬å¯¹å½“å‰äº‹åŠ¡ä¸å¯è§ï¼ˆå¤ªæ–°äº†ï¼‰
      ++current_index;  // è·³è¿‡ï¼ŒæŸ¥æ›´æ—©ç‰ˆæœ¬
    }
  }
  return std::nullopt;  // æ— å¯è§ç‰ˆæœ¬
}
```

### 1.7 å¯åŠ¨ä¸æ¢å¤æµç¨‹ï¼ˆCrash Recoveryï¼‰

WAL çš„æ ¸å¿ƒä»·å€¼åœ¨äºç³»ç»Ÿå´©æºƒåçš„æ¢å¤ã€‚å½“ LSM é‡å¯æ—¶ï¼Œéœ€è¦é€šè¿‡ WAL å°†æœªæŒä¹…åŒ–çš„æ•°æ®é‡æ–°åŠ è½½åˆ° MemTable ä¸­ã€‚

#### æ¢å¤æµç¨‹å›¾

```mermaid
graph TB
    Start["ç³»ç»Ÿå¯åŠ¨"]
    
    subgraph Phase1 ["é˜¶æ®µ 1ï¼šå…ƒæ•°æ®åŠ è½½"]
        P1_1["è¯» Manifest å’Œ tranc_id æ–‡ä»¶"]
        P1_2["LSMEngine å¯åŠ¨ï¼ŒåŠ è½½æ‰€æœ‰ SST ç´¢å¼•"]
        P1_3["å„ SST çš„ Bloom Filterã€Footer åŠ è½½åˆ°å†…å­˜"]
    end
    
    subgraph Phase2 ["é˜¶æ®µ 2ï¼šWAL é‡æ”¾ï¼ˆReplayï¼‰"]
        P2_1["å®šä½æœ€æ–°çš„ WAL æ–‡ä»¶"]
        P2_2["ä»å¤´éå† Record"]
        P2_3["æŒ‰äº‹åŠ¡åˆ†ç»„"]
        P2_4["æ£€æŸ¥æ˜¯å¦æœ‰ COMMIT Record"]
        P2_5{"è¯¥äº‹åŠ¡å·²æäº¤?"}
        P2_YES["âœ… æ˜¯ï¼šåº”ç”¨æ‰€æœ‰ PUT/DELETE åˆ° MemTable"]
        P2_NO["âŒ å¦ï¼šä¸¢å¼ƒï¼ˆæœªæäº¤äº‹åŠ¡ï¼Œæ— éœ€æ¢å¤ï¼‰"]
    end
    
    subgraph Phase3 ["é˜¶æ®µ 3ï¼šæ¢å¤å®Œæˆ"]
        P3_1["é‡å»º Memtable ç‰ˆæœ¬é“¾"]
        P3_2["æ›´æ–° next_sst_id å’Œäº‹åŠ¡ ID æ°´ä½çº¿"]
        P3_3["ç³»ç»Ÿå°±ç»ªï¼Œå¯¹å¤–æä¾›æœåŠ¡"]
    end
    
    Start --> P1_1
    P1_1 --> P1_2
    P1_2 --> P1_3
    P1_3 --> P2_1
    P2_1 --> P2_2
    P2_2 --> P2_3
    P2_3 --> P2_4
    P2_4 --> P2_5
    P2_5 --> P2_YES
    P2_5 --> P2_NO
    P2_YES --> P3_1
    P2_NO --> P3_1
    P3_1 --> P3_2
    P3_2 --> P3_3
    
    style Phase1 fill:#e1f5fe
    style Phase2 fill:#fff3e0
    style Phase3 fill:#c8e6c9
```

#### æ¢å¤çš„æ ¸å¿ƒä»£ç ï¼ˆLSM æ„é€ å‡½æ•°ï¼‰

```cpp
LSM::LSM(std::string path) {
  // 1. åˆå§‹åŒ–å¼•æ“å’Œäº‹åŠ¡ç®¡ç†
  engine = std::make_shared<LSMEngine>(path);
  tran_manager_ = std::make_shared<TranManager>(path);
  tran_manager_->set_engine(engine);
  
  // 2. WAL é‡æ”¾ï¼šcheck_recover() è¯»å– WALï¼ŒæŒ‰äº‹åŠ¡åˆ†ç»„
  auto recover_map = tran_manager_->check_recover();
  
  // 3. é€ä¸ªäº‹åŠ¡å¤„ç†
  for (auto &[tran_id, records] : recover_map) {
    bool has_commit = false;
    
    // æ£€æŸ¥è¯¥äº‹åŠ¡æ˜¯å¦å·²æäº¤
    for (auto &record : records) {
      if (record.getOperationType() == OperationType::COMMIT) {
        has_commit = true;
        break;
      }
    }
    
    // è‹¥å·²æäº¤ï¼Œé‡æ”¾æ‰€æœ‰æ“ä½œ
    if (has_commit) {
      for (auto &record : records) {
        if (record.getOperationType() == OperationType::PUT) {
          engine->memtable.put(record.getKey(), record.getValue(), 
                              record.getTrancId());
        } else if (record.getOperationType() == OperationType::DELETE) {
          engine->memtable.remove(record.getKey(), record.getTrancId());
        }
      }
    }
    // è‹¥æœªæäº¤ï¼Œè·³è¿‡ï¼ˆç¬¦åˆ ACID ä¸­çš„åŸå­æ€§ï¼‰
  }
}
```

#### å…³é”®è®¾è®¡ç‚¹

| é˜¶æ®µ | è®¾è®¡è¦ç‚¹                              | åŸå›                                |
| ------ | --------------------------------------- | ------------------------------------ |
| **COMMIT æ£€æŸ¥**     | åªæœ‰åŒ…å« COMMIT Record çš„äº‹åŠ¡æ‰è¢«é‡æ”¾ | ä¿è¯åŸå­æ€§ï¼šæœªæäº¤çš„æ›´æ–°ä¸ä¼šè¢«åº”ç”¨ |
| **é¡ºåºé‡æ”¾**     | æŒ‰ WAL ä¸­çš„é¡ºåºåº”ç”¨ PUT/DELETE        | ä¿è¯å› æœä¸€è‡´æ€§                     |
| **ç‰ˆæœ¬æˆ³ä¿ç•™**     | ä½¿ç”¨ record.getTrancId() è€Œéæ–° ID    | ä¿è¯æ¢å¤åçš„ç‰ˆæœ¬é“¾ä¸åŸå§‹ä¸€è‡´       |
| **MemTable æ›´æ–°**     | ç›´æ¥è°ƒç”¨ put/removeï¼ˆæ— ç¼“å†²ï¼‰         | é¿å…ä¸¢å¤±æ¢å¤çš„æ•°æ®                 |

#### æ•…éšœåœºæ™¯åˆ†æ

```
åœºæ™¯ 1ï¼šCommit å‰å´©æºƒ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WAL: BEGIN[T100] PUT(k1,v1) â† å´©æºƒ
æ¢å¤: æœªæ‰¾åˆ° COMMITï¼ŒT100 è¢«å¿½ç•¥
ç»“æœ: âœ… æ•°æ®ä¸¢å¤±ï¼Œç¬¦åˆé¢„æœŸï¼ˆäº‹åŠ¡æœªæäº¤ï¼‰

åœºæ™¯ 2ï¼šCommit åã€Flush å‰å´©æºƒ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WAL: BEGIN[T100] PUT(k1,v1) COMMIT[T100] â† å´©æºƒ
æ¢å¤: æ‰¾åˆ° COMMITï¼Œé‡æ”¾ PUT(k1,v1)
ç»“æœ: âœ… æ•°æ®æ¢å¤åˆ° Memtableï¼ˆå°šæœª Flush åˆ° SSTï¼‰

åœºæ™¯ 3ï¼šå®Œå…¨æ¢å¤ï¼ˆæ­£å¸¸è¿è¡Œï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WAL: BEGIN[T100] PUT(k1,v1) COMMIT[T100]
æ¢å¤: é‡æ”¾æ•°æ®åˆ° Memtable
åç»­: Memtable æ»¡æ—¶ Flush åˆ° SSTï¼ŒWAL å¯æ¸…ç†
ç»“æœ: âœ… å®Œæ•´æ¢å¤ï¼Œç³»ç»Ÿå¯ç»§ç»­æ­£å¸¸è¿è¡Œ
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šè¯»å–ä¼˜åŒ–é“¾è·¯ (Bloom Filter & Cache)

### 2.1 Bloom Filter çš„é›†æˆä½ç½®

```mermaid
flowchart TD
    Start["LSMEngine::get<br/>key, tranc_id"]
    
    subgraph MemRead ["MemTable è¯»å–ï¼ˆæ— è¿‡æ»¤ï¼‰"]
        M1["MemTable::get(key, tranc_id)"]
        M2{"æ‰¾åˆ°?"}
        MRet["è¿”å›å€¼"]
    end
    
    subgraph L0Read ["L0 éå†ï¼ˆå¯é‡å ï¼‰"]
        L0Loop["for each SST in L0:"]
        BloomCheck["ğŸ“ Bloom Filter Check<br/>possibly_contains(key)?"]
        BloomResult{"æ˜¯å¦å¯èƒ½å­˜åœ¨?"}
        SkipSST["âŒ è·³è¿‡æ­¤ SST<br/>ï¼ˆç¡®å®šä¸å­˜åœ¨ï¼‰"]
        ReadSST["âœ… è¯»å– SST<br/>ï¼ˆå¯èƒ½å­˜åœ¨ï¼‰"]
        L0Get["SST::get(key, tranc_id)"]
        L0Found{"æ‰¾åˆ°?"}
        L0Ret["è¿”å›"]
    end
    
    subgraph L1Read ["L1+ äºŒåˆ†æŸ¥æ‰¾"]
        BinSearch["äºŒåˆ†æŸ¥æ‰¾<br/>ï¼ˆæ¯”è¾ƒ first_key/last_keyï¼‰"]
        L1Bloom["ğŸ“ Bloom Filter Check<br/>å¯é€‰ï¼Œå‡å°‘ Block è¯»å–"]
        L1Get["SST::get(key, tranc_id)"]
        L1Ret["è¿”å›"]
    end
    
    NotFound["è¿”å› NULL"]
    End["ç»“æŸ"]
    
    Start --> M1
    M1 --> M2
    M2 -->|æ˜¯| MRet
    M2 -->|å¦| L0Loop
    MRet --> End
    
    L0Loop --> BloomCheck
    BloomCheck --> BloomResult
    BloomResult -->|å¦| SkipSST
    BloomResult -->|æ˜¯| ReadSST
    SkipSST --> L0Loop
    ReadSST --> L0Get
    L0Get --> L0Found
    L0Found -->|æ˜¯| L0Ret
    L0Found -->|å¦ï¼Œç»§ç»­éå†| L0Loop
    L0Ret --> End
    
    L0Loop -->|L0 å…¨éƒ¨æŸ¥å®Œ| BinSearch
    BinSearch --> L1Bloom
    L1Bloom --> L1Get
    L1Get --> L1Ret
    L1Ret --> End
    
    L0Found -->|æ— å¯è§ç‰ˆæœ¬| L0Loop
    L1Ret -->|æœªæ‰¾åˆ°| NotFound
    NotFound --> End
    
    style BloomCheck fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style L1Bloom fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style SkipSST fill:#ffcdd2
    style ReadSST fill:#c8e6c9
    style Start fill:#f3e5f5
    style End fill:#f3e5f5
```

### 2.2 Bloom Filter åŸç†ä¸å‚æ•°

```cpp
class BloomFilter {
private:
  size_t expected_elements_;     // é¢„æœŸå…ƒç´ æ•°é‡
  double false_positive_rate_;   // å…è®¸çš„å‡é˜³æ€§ç‡ï¼ˆå¦‚ 0.01ï¼‰
  size_t num_bits_;              // ä½æ•°ç»„å¤§å° = expected_elements * ln(2)^2 / ln(FPR)
  size_t num_hashes_;            // å“ˆå¸Œå‡½æ•°æ•°é‡ = num_bits * ln(2) / expected_elements
  std::vector<bool> bits_;       // ä½æ•°ç»„
  
public:
  void add(const std::string &key);
  bool possibly_contains(const std::string &key) const;
};
```

#### å‚æ•°ç¤ºä¾‹

å¯¹äº 10,000 ä¸ªå…ƒç´ ã€å‡é˜³æ€§ç‡ 1%ï¼š

- **ä½æ•°ç»„å¤§å°** = 10,000 Ã— 9.58 â‰ˆ 95,800 bits â‰ˆ 12 KB
- **å“ˆå¸Œå‡½æ•°æ•°** = 95,800 Ã— 0.693 / 10,000 â‰ˆ 7 ä¸ª
- **æŸ¥è¯¢æˆæœ¬** = 7 æ¬¡å“ˆå¸Œè®¡ç®—ï¼ˆè¿œå°äºç£ç›˜ I/Oï¼‰

#### é›†æˆç‚¹è¯¦è§£

| ä½ç½® | æ—¶æœº           | ä½œç”¨                           | èŠ‚çœæˆæœ¬             |
| ------ | ---------------- | -------------------------------- | ---------------------- |
| **SST æ„å»º**     | å†™å…¥ Block æ—¶  | æ¯ä¸ª SST ç»´æŠ¤ä¸€ä¸ª Bloom Filter | -                    |
| **L0 éå†**     | è¯»å– L0 SST å‰ | å¿«é€Ÿæ’é™¤ä¸åŒ…å« key çš„ SST      | é¿å…è§£æ Block       |
| **L1+ äºŒåˆ†**     | å¯é€‰ä¼˜åŒ–       | åœ¨è·å– Block å‰åšäºŒæ¬¡æ£€æŸ¥      | å‡å°‘ BlockCache ç«äº‰ |

#### Bloom Filter ç”Ÿå‘½å‘¨æœŸä¸å†…å­˜å¸¸é©»

**å…³é”®è®¾è®¡**ï¼šBloom Filter çš„æ•°æ®å—ï¼ˆé€šå¸¸ 12-64KBï¼‰å­˜å‚¨åœ¨ SST æ–‡ä»¶æœ«å°¾ï¼Œä½†**è¢«åŠ è½½åˆ°å†…å­˜åå¸¸é©»ä¸å¸è½½**ã€‚

```
SST æ–‡ä»¶ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Data Block Section             â”‚  â† å®é™… KV æ•°æ®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Metadataï¼ˆFooterï¼‰             â”‚  â† SST ç´¢å¼•
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ Bloom Filterï¼ˆ12-64KBï¼‰        â”‚  â† ä½æ•°ç»„ï¼ˆå¸¸é©»å†…å­˜ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç”Ÿå‘½å‘¨æœŸ**ï¼š

1. **SST ç”Ÿæˆæ—¶**ï¼šSSTBuilder ç´¯ç§¯æ‰€æœ‰ keyï¼Œç¼–ç ç”Ÿæˆ Bloom Filter æ•°æ®å—ï¼Œåºåˆ—åŒ–åˆ°æ–‡ä»¶
2. **SST::open() æ—¶**ï¼šç³»ç»Ÿå¯åŠ¨æˆ– Compaction å®Œæˆåï¼Œè¯»å– SST æ–‡ä»¶ï¼Œå°† Bloom Filter åŠ è½½åˆ°å†…å­˜ï¼ˆé™„ç€åœ¨ SST å¯¹è±¡çš„ `bloom_filter_` æˆå‘˜ï¼‰
3. **Get æŸ¥è¯¢æ—¶**ï¼šç›´æ¥è°ƒç”¨ `bloom_filter_->possibly_contains(key)`ï¼Œæ“ä½œå®Œå…¨åœ¨å†…å­˜è¿›è¡Œï¼Œ**æ— éœ€ç£ç›˜ I/O**
4. **LSMEngine ç”Ÿå‘½å‘¨æœŸç»“æŸ**ï¼šéš SST å¯¹è±¡ææ„è€Œé‡Šæ”¾

**æ€§èƒ½å«ä¹‰**ï¼š

- **æŸ¥è¯¢æˆæœ¬** = 7 æ¬¡å“ˆå¸Œè®¡ç®—ï¼ˆâ‰ˆ å¾®ç§’çº§ï¼‰
- **æ— ç£ç›˜ I/O**ï¼šä¸åƒ Block éœ€è¦ä»ç¼“å­˜æˆ–ç£ç›˜è¯»å–
- **ä¸ BlockCache äº’è¡¥**ï¼šBloom Filter å¿«é€Ÿæ’é™¤ â†’ BlockCache ç¼“å­˜çƒ­ Block â†’ æ•´ä½“è¯»å»¶è¿Ÿå¤§å¹…é™ä½

### 2.3 BlockCache çš„ LRU-K å®ç°

```cpp
class BlockCache {
private:
  size_t capacity_;                    // ç¼“å­˜å®¹é‡ï¼ˆå¦‚ 100 ä¸ª Blockï¼‰
  size_t k_;                           // LRU-K ä¸­çš„ K å€¼
  std::list<CacheItem> cache_list_greater_k;  // K æ¬¡ä»¥ä¸Šè®¿é—®çš„é¡¹
  std::list<CacheItem> cache_list_less_k;     // K æ¬¡ä»¥ä¸‹è®¿é—®çš„é¡¹
  
  struct CacheItem {
    int sst_id;
    int block_id;
    std::shared_ptr<Block> cache_block;
    uint64_t access_count;             // è®¿é—®è®¡æ•°
  };
};
```

#### LRU-K çš„æ·˜æ±°ç­–ç•¥

```mermaid
graph TB
    Request["Block è®¿é—®è¯·æ±‚<br/>(sst_id, block_id)"]
    
    subgraph LookUp ["æŸ¥è¯¢é˜¶æ®µ"]
        InCache{"Block<br/>åœ¨ç¼“å­˜ä¸­?"}
        Hit["âœ… Cache Hit<br/>update_access_count++"]
        Miss["âŒ Cache Miss<br/>è¯»å–ç£ç›˜"]
    end
    
    subgraph Insert ["æ’å…¥é˜¶æ®µ"]
        CheckCap{"ç¼“å­˜å·²æ»¡?"}
        Add["âœ… ç›´æ¥æ·»åŠ <br/>access_count=1"]
        Evict["âŒ éœ€è¦æ·˜æ±°"]
        EvictLess["ä¼˜å…ˆæ·˜æ±°<br/>access_count < k<br/>ä¸”æœ€ä¹…æœªç”¨"]
        EvictMore["å…¶æ¬¡æ·˜æ±°<br/>access_count â‰¥ k<br/>ä¸”æœ€ä¹…æœªç”¨"]
        DoEvict["æ‰§è¡Œæ·˜æ±°<br/>ç§»å‡ºç¼“å­˜"]
    end
    
    Request --> InCache
    InCache -->|æ˜¯| Hit
    InCache -->|å¦| Miss
    
    Miss --> CheckCap
    CheckCap -->|å¦| Add
    CheckCap -->|æ˜¯| Evict
    
    Evict --> EvictLess
    EvictLess --> EvictMore
    EvictMore --> DoEvict
    DoEvict --> Add
    
    style Hit fill:#c8e6c9
    style Miss fill:#ffccbc
    style DoEvict fill:#ffcdd2
```

#### BlockCache ä¸ Bloom Filter çš„ååŒ

```
SST è¯»å–æµç¨‹ï¼š
1. Get(key, tranc_id)
   â”œâ”€ Bloom Filter::possibly_contains(key)
   â”‚  â””â”€ è¿”å› false â†’ è¿”å› NULLï¼ˆèŠ‚çœ I/Oï¼‰
   â”‚  â””â”€ è¿”å› true  â†’ ç»§ç»­è¯» Block
   â”‚
   â””â”€ SST::find_block_idx(key) â†’ å®šä½ Block ID
      â””â”€ BlockCache::get(sst_id, block_id)
         â”œâ”€ Hit   â†’ è¿”å›ç¼“å­˜çš„ Block å¯¹è±¡
         â”œâ”€ Miss  â†’ ä»ç£ç›˜è¯»å– Block
         â”‚         â”œâ”€ ååºåˆ—åŒ– Block æ•°æ®
         â”‚         â”œâ”€ æ’å…¥ BlockCacheï¼ˆLRU-Kï¼‰
         â”‚         â””â”€ è¿”å› Block å¯¹è±¡
         â””â”€ è§£æ Block â†’ æŸ¥è¯¢ (key, value, tranc_id)
```

### 2.4 ç¼“å­˜æ•ˆç‡æŒ‡æ ‡

```cpp
double BlockCache::hit_rate() const {
  // å‘½ä¸­ç‡ = å‘½ä¸­æ¬¡æ•° / æ€»è¯·æ±‚æ¬¡æ•°
  return (double)hit_requests_ / total_requests_;
}
```

**æ€§èƒ½å½±å“ç¤ºä¾‹**ï¼š

- **hit_rate = 90%** ï¼šå¹³å‡å»¶è¿Ÿ = 0.9 Ã— (å†…å­˜è®¿é—® 10Î¼s) + 0.1 Ã— (ç£ç›˜è¯» 5ms) â‰ˆ 0.5ms
- **hit_rate = 50%** ï¼šå¹³å‡å»¶è¿Ÿ = 0.5 Ã— 10Î¼s + 0.5 Ã— 5ms â‰ˆ 2.5msï¼ˆ5 å€å·®å¼‚ï¼‰

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šSST å‹ç¼©æœºåˆ¶ (Compaction)

### 3.1 å‹ç¼©ç­–ç•¥é€‰æ‹©

Tiny-LSM é‡‡ç”¨ **Leveling ç­–ç•¥**ï¼ˆç±»ä¼¼ LevelDBï¼‰ï¼Œè€Œé Tieringï¼ˆç±»ä¼¼ RocksDBï¼‰ã€‚

```mermaid
graph TB
    subgraph Leveling ["Leveling ç­–ç•¥ï¼ˆTiny-LSMï¼‰"]
        L0L["L0: å¯é‡å <br/>æœ€å¤š 4 ä¸ª SST"]
        L1L["L1: ä¸é‡å <br/>æ€»å¤§å° 10MB<br/>æœ€å¤š 10 ä¸ª SST"]
        L2L["L2: ä¸é‡å <br/>æ€»å¤§å° 100MB<br/>æœ€å¤š 100 ä¸ª SST"]
        L0L -->|è§¦å‘æ¡ä»¶<br/>L0 SST â‰¥ 4| Compact1["L0 + L1<br/>å…¨éƒ¨åˆå¹¶"]
        Compact1 -->|è¾“å‡º| L1L
        L1L -->|è§¦å‘æ¡ä»¶<br/>L1 å¤§å° â‰¥ 10MB| Compact2["L1 + L2<br/>å…¨éƒ¨åˆå¹¶"]
        Compact2 -->|è¾“å‡º| L2L
    end
    
    subgraph Tiering ["Tiering ç­–ç•¥ï¼ˆä¸é‡‡ç”¨ï¼‰"]
        T0["L0: æ— åº SST"]
        T1["L1: å¯é‡å "]
        T2["L2: å¯èƒ½é‡å "]
        T0 -->|åˆå¹¶æ—¶<br/>ä¸åˆ é™¤åŸæ•°æ®| T1
        T1 -->|åˆå¹¶æ—¶| T2
    end
    
    style Leveling fill:#c8e6c9
    style Tiering fill:#ffccbc
```

**Leveling vs Tiering**ï¼š

| æŒ‡æ ‡ | Leveling             | Tiering            |
| ------ | ---------------------- | -------------------- |
| **L1+ é‡å **     | ä¸é‡å                | å¯èƒ½é‡å            |
| **è¯»æ”¾å¤§**     | ä½ï¼ˆåªéœ€æŸ¥ä¸€ä¸ª SSTï¼‰ | é«˜ï¼ˆå¯èƒ½æŸ¥å¤šä¸ªå±‚ï¼‰ |
| **å†™æ”¾å¤§**     | é«˜ï¼ˆå…¨é‡åˆå¹¶ï¼‰       | ä½ï¼ˆå¢é‡åˆå¹¶ï¼‰     |
| **ç©ºé—´æ”¾å¤§**     | ä½ï¼ˆåŠæ—¶åˆ é™¤ï¼‰       | ä¸­é«˜ï¼ˆä¿ç•™å†å²ï¼‰   |
| **é€‚ç”¨åœºæ™¯**     | è¯»å¤šå†™å°‘             | å†™å¤šè¯»å°‘           |

### 3.2 å‹ç¼©è§¦å‘æ¡ä»¶

```cpp
// src/lsm/engine.cpp ä¸­çš„ flush() å‡½æ•°
uint64_t LSMEngine::flush() {
  // ...
  
  // è§¦å‘æ¡ä»¶ 1ï¼šL0 SST æ•°é‡è¶…é™
  if (level_sst_ids[0].size() >= getLsmSstLevelRatio()) {  // å¦‚ 4
    full_compact(0);  // L0 + L1 åˆå¹¶
  }
  
  // è§¦å‘æ¡ä»¶ 2ï¼šL1+ å¤§å°è¶…é™
  for (size_t level = 1; level <= cur_max_level; level++) {
    if (calc_level_size(level) >= get_sst_size(level)) {
      full_compact(level);  // Lx + L(x+1) åˆå¹¶
    }
  }
}
```

**é˜ˆå€¼é…ç½®**ï¼ˆconfig.tomlï¼‰ï¼š

- `L0 é˜ˆå€¼` = 4 SST
- `L1 å¤§å°` = 10 MBï¼Œ`L2` = 100 MBï¼Œ...ï¼ˆæ¯å±‚ 10 å€é€’è¿›ï¼‰
- `LsmSstLevelRatio` = 10ï¼ˆå±‚çº§å¤§å°é€’å¢å› å­ï¼‰

### 3.3 ä¸€æ¬¡ Compaction çš„å®Œæ•´æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> SelectSource: Compaction è§¦å‘
    
    SelectSource: é€‰æ‹© Source SSTs<br/>ï¼ˆL0 å…¨éƒ¨ + å¯¹åº” L1ï¼‰
    SelectSource --> CalcSize: è®¡ç®—æ•°æ®é‡
    
    CalcSize: é¢„ä¼°è¾“å‡º SST æ•°é‡<br/>target_sst_size = calc_size(L+1)
    CalcSize --> BuildIter: æ„å»ºåˆå¹¶è¿­ä»£å™¨
    
    BuildIter: TwoMergeIterator<br/>(L0_HeapIterator, L1_ConcactIterator, 0)
    BuildIter --> MergeKV: å¤šè·¯å½’å¹¶
    
    MergeKV: éå†è¿­ä»£å™¨
    MergeKV --> ProcessTomb: å¤„ç† Tombstone
    
    ProcessTomb: æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬<br/>æ˜¯å¦ä¸º Tombstoneï¼Ÿ
    ProcessTomb --> TombYes: âŒ æ˜¯ï¼šä¸¢å¼ƒæ•´æ¡é“¾<br/>ï¼ˆç‰©ç†åˆ é™¤ï¼‰
    ProcessTomb --> TombNo: âœ… å¦ï¼šä¿ç•™<br/>å†™å…¥æ–° SST
    
    TombYes --> AddBuilder
    TombNo --> AddBuilder
    
    %% ä¿®æ”¹å¤„ 1ï¼šä½¿ç”¨ alias è¯­æ³•é¿å…åŒå†’å·æŠ¥é”™
    state "SSTBuilder::add<br/>ç´¯ç§¯ KV å¯¹" as AddBuilder
    AddBuilder --> CheckSize: æ£€æŸ¥ Builder å¤§å°
    
    CheckSize --> SizeOK: æœªè¾¾åˆ°é˜ˆå€¼<br/>ç»§ç»­ç´¯ç§¯
    CheckSize --> SizeExceed: è¾¾åˆ°é˜ˆå€¼<br/>ç”Ÿæˆæ–° SST
    
    SizeOK --> MergeKV
    
    %% ä¿®æ”¹å¤„ 2ï¼šåŒæ ·å¤„ç† GenSST ä¸­çš„ ::build
    state "è°ƒç”¨ SSTBuilder::build<br/>ç”Ÿæˆ SST æ–‡ä»¶<br/>å†™å…¥ç£ç›˜<br/>åˆ›å»ºå…ƒæ•°æ®ï¼ˆBloom, Footerï¼‰" as GenSST
    SizeExceed --> GenSST
    
    GenSST --> UpdateManifest: æ›´æ–° level_sst_ids å’Œ ssts Map
    UpdateManifest --> IterEnd: è¿­ä»£å™¨æ˜¯å¦ç»“æŸï¼Ÿ
    
    IterEnd --> IterMore: å¦ï¼šç”Ÿæˆæ›´å¤š SST<br/>ç»§ç»­å¾ªç¯
    IterEnd --> Complete: æ˜¯ï¼šCompaction å®Œæˆ
    
    IterMore --> GenSST
    
    Complete --> Cleanup: åˆ é™¤æ—§ SST æ–‡ä»¶<br/>ï¼ˆL0 å’Œ L1 åŸæ–‡ä»¶ï¼‰
    Cleanup --> [*]
    
    style SelectSource fill:#fff9c4
    style BuildIter fill:#e1f5fe
    style MergeKV fill:#f3e5f5
    style ProcessTomb fill:#ffccbc
    style TombYes fill:#ffcdd2
    style TombNo fill:#c8e6c9
    style GenSST fill:#e8f5e9
    style UpdateManifest fill:#fff3e0
    style Complete fill:#c8e6c9
```

### 3.4 å…³é”®ä»£ç æ®µåˆ†æ

#### L0 + L1 Compactionï¼ˆå®Œå…¨åˆå¹¶ï¼‰

```cpp
std::vector<std::shared_ptr<SST>>
LSMEngine::full_l0_l1_compact(std::vector<size_t> &l0_ids, 
                               std::vector<size_t> &l1_ids) {
  // 1. æ„å»º L0 è¿­ä»£å™¨ï¼ˆå¤šä¸ª SST å¯èƒ½é‡å ï¼Œä½¿ç”¨ HeapIterator å¤šè·¯åˆå¹¶ï¼‰
  std::vector<SstIterator> l0_iters;
  for (auto id : l0_ids) {
    l0_iters.push_back(ssts[id]->begin(0));  // tranc_id=0 è¡¨ç¤ºå¿½ç•¥ç‰ˆæœ¬æ§åˆ¶
  }
  auto [l0_begin, l0_end] = SstIterator::merge_sst_iterator(l0_iters, 0);
  std::shared_ptr<HeapIterator> l0_begin_ptr = 
      std::make_shared<HeapIterator>(std::move(l0_begin));
  
  // 2. æ„å»º L1 è¿­ä»£å™¨ï¼ˆSST ä¸é‡å ï¼Œä½¿ç”¨ ConcactIterator ä¸²è”ï¼‰
  std::vector<std::shared_ptr<SST>> l1_ssts;
  for (auto id : l1_ids) {
    l1_ssts.push_back(ssts[id]);
  }
  std::shared_ptr<ConcactIterator> l1_begin_ptr =
      std::make_shared<ConcactIterator>(l1_ssts, 0);
  
  // 3. åŒè·¯åˆå¹¶ï¼ˆL0 å’Œ L1 çš„æœ‰åºæµï¼‰
  TwoMergeIterator l0_l1_begin(l0_begin_ptr, l1_begin_ptr, 0);
  
  // 4. å†™å…¥æ–° SSTï¼ˆè‡ªåŠ¨å¤„ç† Tombstone æ¸…ç†ï¼‰
  return gen_sst_from_iter(l0_l1_begin, 
                           getLsmPerMemSizeLimit() * getLsmSstLevelRatio(),
                           1);  // ç›®æ ‡ level = 1
}
```

 **ğŸ”‘ å…³é”®è®¾è®¡ç‚¹ï¼šSST ID çš„å…¨å±€å”¯ä¸€æ€§**

åœ¨ `gen_sst_from_iter` ä¸­åˆ›å»ºæ–° SST æ—¶ï¼š

```cpp
size_t sst_id = next_sst_id++;  // âš ï¸ å…¨å±€é€’å¢ï¼Œè€Œéå±‚çº§å†…çš„ä¸‹æ ‡
```

**ä¸ºä»€ä¹ˆå¿…é¡»å…¨å±€å”¯ä¸€**ï¼š

- BlockCache çš„ Key = `(sst_id, block_id)`
- å¦‚æœ sst_id åªæ˜¯å±‚çº§å†…ä¸‹æ ‡ï¼ˆä¾‹å¦‚ L0 çš„ç¬¬ 0 ä¸ªæ–‡ä»¶å’Œ L1 çš„ç¬¬ 0 ä¸ªæ–‡ä»¶éƒ½ç”¨ ID=0ï¼‰ï¼Œä¼šå¯¼è‡´**ç¼“å­˜é”®å†²çª**
- ç¤ºä¾‹ï¼š

  ```
  L0[0] çš„ Block 0 â†’ Key = (0, 0) â†’ ç¼“å­˜é¡¹ A
  L1[0] çš„ Block 0 â†’ Key = (0, 0) â†’ ç¼“å­˜é¡¹ Bï¼ˆè¦†ç›– Aï¼ï¼‰
  é”™è¯¯ï¼šL0 çš„æ•°æ®è¢«æ„å¤–æ›¿æ¢
  ```

**æ­£ç¡®å®ç°**ï¼š

- `next_sst_id` æ˜¯ LSMEngine çš„å…¨å±€è®¡æ•°å™¨
- æ¯æ¬¡ç”Ÿæˆ SSTï¼Œé€’å¢ååˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ IDï¼ˆå¦‚ 1, 2, 3, ..., 100, 101, ...ï¼‰
- BlockCache ä¸­çš„ (sst_id, block_id) å¯¹æ°¸è¿œä¸ä¼šå†²çª

#### Tombstone å¤„ç†ï¼ˆç‰©ç†åˆ é™¤ï¼‰

```cpp
std::vector<std::shared_ptr<SST>>
LSMEngine::gen_sst_from_iter(BaseIterator &iter, size_t target_sst_size,
                              size_t target_level) {
  std::vector<std::shared_ptr<SST>> new_ssts;
  SSTBuilder builder(...);
  
  while (iter.is_valid() && !iter.is_end()) {
    auto kv = *iter;
    
    // å…³é”®åˆ¤æ–­ï¼šæ˜¯å¦ä¸º Tombstoneï¼ˆç©ºå€¼ï¼‰
    if (kv.second.size() == 0) {
      // Tombstoneï¼šåœ¨ Compaction æœ€åä¸€å±‚å¯ä»¥ç‰©ç†åˆ é™¤
      if (target_level >= cur_max_level) {
        // æœ€åä¸€å±‚ï¼šè·³è¿‡ Tombstoneï¼Œæ‰§è¡Œç‰©ç†åˆ é™¤
        ++iter;
        continue;
      } else {
        // éæœ€åä¸€å±‚ï¼šä¿ç•™ Tombstoneï¼ˆä¾›åç»­ Compaction æŸ¥è¯¢ï¼‰
        builder.add(kv.first, kv.second, 0);
      }
    } else {
      // æ­£å¸¸ KV å¯¹ï¼šç›´æ¥æ·»åŠ 
      builder.add(kv.first, kv.second, 0);
    }
    
    ++iter;
    
    // æ„å»º SST
    if (builder.estimated_size() >= target_sst_size) {
      size_t sst_id = next_sst_id++;
      auto new_sst = builder.build(sst_id, path, block_cache);
      new_ssts.push_back(new_sst);
      builder = SSTBuilder(...);  // é‡ç½®
    }
  }
  return new_ssts;
}
```

### 3.5 Compaction çš„æ€§èƒ½å½±å“

#### è¯»å†™æ”¾å¤§æƒè¡¡

```mermaid
graph LR
    subgraph ReadAmp ["è¯»æ”¾å¤§ vs å†™æ”¾å¤§"]
        NoCompact["âŒ ä¸åš Compaction<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>è¯»å»¶è¿Ÿï¼šO(L)<br/>L = å±‚æ•°<br/>éœ€æŸ¥å¤šå±‚ SST<br/><br/>å†™å»¶è¿Ÿï¼šO(1)<br/>ç›´æ¥ flush"]
        
        LevelingComp["âœ… Leveling<br/>ï¼ˆTiny-LSMï¼‰<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>è¯»å»¶è¿Ÿï¼šO(1)<br/>L1+ å·²æ’åº<br/>æŸ¥å•ä¸ª SST<br/><br/>å†™æ”¾å¤§ï¼šO(10^L)<br/>æ¯å±‚åˆå¹¶ 10 å€<br/>å†™å…¥ä»£ä»·é«˜"]
        
        TieringComp["âœ… Tiering<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>è¯»å»¶è¿Ÿï¼šO(L)<br/>å¯èƒ½å¤šå±‚é‡å <br/>æŸ¥å¤šä¸ª SST<br/><br/>å†™æ”¾å¤§ï¼šO(L)<br/>å¢é‡åˆå¹¶<br/>å†™å…¥ä»£ä»·ä½"]
    end
    
    NoCompact -->|ç”¨äº| LiteLSM["æ—  Compaction LSM<br/>ï¼ˆæ•™å­¦åœºæ™¯ï¼‰"]
    LevelingComp -->|ç”¨äº| OLTPLoad["OLTP è¯»å¤š<br/>ï¼ˆMySQL/PGï¼‰"]
    TieringComp -->|ç”¨äº| OLAPLoad["OLAP å†™å¤š<br/>ï¼ˆClickHouseï¼‰"]
    
    style ReadAmp fill:#f5f5f5
    style LevelingComp fill:#c8e6c9
    style TieringComp fill:#fff9c4
```

#### å†™æ”¾å¤§è®¡ç®—

å‡è®¾é…ç½®ï¼š

- L0ï¼š4 ä¸ª SSTï¼Œæ¯ä¸ª 1MB
- L1ï¼š10 ä¸ª SSTï¼Œå…± 10MB
- Leveling ç­–ç•¥

**ä¸€æ¬¡ Compaction çš„å†™æ”¾å¤§**ï¼š

```
è¾“å…¥æ•°æ®é‡   = L0 (4MB) + L1 (10MB) = 14MB
è¾“å‡ºæ•°æ®é‡   = æ–° L1 SST â‰ˆ 14MB
å†™æ”¾å¤§ç³»æ•°   = è¾“å‡º / è¾“å…¥ â‰ˆ 1

ä½†æ˜¯ï¼ŒL1 åˆ° L2 åˆä¼šè§¦å‘ Compactionï¼š
è¾“å…¥         = L1 (14MB) + L2 (100MB) = 114MB
è¾“å‡º         = æ–° L2 (114MB)
å†™æ”¾å¤§ç³»æ•°   = 114 / 14 â‰ˆ 8

æ€»ä½“å†™æ”¾å¤§   = 1 Ã— 8 Ã— 100 â‰ˆ 800xï¼ˆç›¸æ¯”åŸå§‹æ•°æ®ï¼‰
```

#### Tombstone çš„ç©ºé—´å›æ”¶æ•ˆç‡

```mermaid
graph TB
    Before["Compaction å‰<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>L0: 1000 ä¸ª KV<br/>å…¶ä¸­ 300 ä¸ªæ˜¯<br/>DELETE(key, '', ID)<br/><br/>L1: 2000 ä¸ª KV<br/>å…¶ä¸­ 500 ä¸ªæ˜¯<br/>Tombstone"]
    
    After["Compaction å<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>L1: 2000 ä¸ª KV<br/>300 ä¸ª DELETE å·²æ¸…é™¤<br/>300 ä¸ªæœ‰æ•ˆå€¼ä¿ç•™<br/>500 ä¸ª Tombstone ä¿ç•™<br/>ï¼ˆä¾›åç»­æŸ¥è¯¢ï¼‰<br/><br/>ç©ºé—´èŠ‚çœï¼šâ‰ˆ 300 Ã— key_size"]
    
    FinalClean["æœ€ç»ˆå±‚ Compaction<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>åˆ°è¾¾æœ€åå±‚æ—¶<br/>æ‰€æœ‰ Tombstone ç‰©ç†åˆ é™¤<br/>å®Œå…¨ç©ºé—´å›æ”¶<br/>ï¼ˆä¸å†éœ€è¦ç‰ˆæœ¬é“¾ï¼‰"]
    
    Before -->|è§¦å‘| After
    After -->|ç»§ç»­| FinalClean
    
    style Before fill:#ffccbc
    style After fill:#fff9c4
    style FinalClean fill:#c8e6c9
```

### 3.6 Compaction ä¸ç³»ç»Ÿå¯ç”¨æ€§

#### åå°å‹ç¼©çš„æŒ‘æˆ˜

| æŒ‘æˆ˜ | å½±å“                                    | è§£å†³æ–¹æ¡ˆ                  |
| ------ | ----------------------------------------- | --------------------------- |
| **å†™å…¥å»¶è¿Ÿæ¯›åˆº**     | Compaction å ç”¨ç£ç›˜ I/Oï¼Œè¯»è¯·æ±‚å»¶è¿Ÿä¸Šå‡ | é™æµã€ä¼˜å…ˆçº§é˜Ÿåˆ—ã€å¤šçº¿ç¨‹  |
| **å†…å­˜æº…å°„**     | ä¸´æ—¶æ„å»ºçš„å¤§å‹è¿­ä»£å™¨å ç”¨å†…å­˜            | æµå¼å¤„ç†ã€åˆ†æ‰¹åˆå¹¶        |
| **å…ƒæ•°æ®ä¸€è‡´æ€§**     | Compaction ä¸­é€”å´©æºƒå¯¼è‡´ SST æ‚¬ç©º        | WAL + Manifest äºŒé˜¶æ®µæäº¤ |
| **UI æŠ–åŠ¨**     | p99 å»¶è¿Ÿæˆå€å¢åŠ                         | è‡ªé€‚åº”å‹ç¼©ã€å‚æ•°è°ƒä¼˜      |

---

## æ€»ç»“ï¼šä¸‰å±‚ç³»ç»Ÿçš„ååŒ

```mermaid
graph TB
    subgraph Trans ["ç¬¬ä¸€å±‚ï¼šäº‹åŠ¡å¯è§æ€§"]
        MVCC["MVCC<br/>ç‰ˆæœ¬æˆ³"]
        WAL["WAL<br/>åŸå­æ€§ä¿è¯"]
        Conflict["å†²çªæ£€æµ‹<br/>ä¹è§‚å¹¶å‘"]
    end
    
    subgraph Opt ["ç¬¬äºŒå±‚ï¼šè¯»æ€§èƒ½ä¼˜åŒ–"]
        Bloom["Bloom Filter<br/>å¿«é€Ÿæ’é™¤"]
        Cache["BlockCache<br/>çƒ­æ•°æ®ç¼“å­˜"]
        Iterator["è¿­ä»£å™¨<br/>é›¶æ‹·è´"]
    end
    
    subgraph Compact ["ç¬¬ä¸‰å±‚ï¼šåå°å‹ç¼©"]
        L0L1["L0â†”L1<br/>å…¨é‡åˆå¹¶"]
        LxLy["Lxâ†”Ly<br/>å¢é‡åˆå¹¶"]
        Tombstone["Tombstone<br/>ç‰©ç†åˆ é™¤"]
    end
    
    MVCC --> Bloom
    WAL --> Compact
    Conflict --> Compact
    
    Bloom --> Cache
    Cache --> Iterator
    
    L0L1 --> LxLy
    LxLy --> Tombstone
    
    Tombstone --> MVCC
    
    style Trans fill:#e1f5fe,stroke:#01579b
    style Opt fill:#f3e5f5,stroke:#4a148c
    style Compact fill:#e8f5e9,stroke:#1b5e20
```

**ååŒæ•ˆåº”**ï¼š

1. **äº‹åŠ¡å±‚**ä¸ºæ‰€æœ‰æ•°æ®èµ‹äºˆç‰ˆæœ¬æˆ³ï¼Œæ”¯æŒ MVCC å¯è§æ€§
2. **ä¼˜åŒ–å±‚**åˆ©ç”¨ Bloom Filter å’Œ Cache å‡å°‘ç£ç›˜ I/O
3. **å‹ç¼©å±‚**åœ¨åå°æ•´ç†æ•°æ®ï¼Œåˆ é™¤å†å²ç‰ˆæœ¬å’Œ Tombstone
4. **åé¦ˆå¾ªç¯**ï¼šWAL è®°å½•çš„æ›´æ–°è¢«åº”ç”¨åˆ° Memtable â†’ Flush åˆ° SST â†’ Compaction æ¸…ç†è¿‡æœŸæ•°æ® â†’ ä¸‹ä¸€ä¸ªäº‹åŠ¡é‡å¤

è¿™ç§åˆ†å±‚æ¶æ„ä½¿å¾— Tiny-LSM èƒ½å¤ŸåŒæ—¶æ”¯æŒ**äº‹åŠ¡ä¸€è‡´æ€§ã€é«˜æ•ˆè¯»å–å’Œåå°æ¸…ç†**ï¼Œæ˜¯ç°ä»£ LSM å­˜å‚¨å¼•æ“çš„å…¸å‹è®¾è®¡æ¨¡å¼ã€‚
